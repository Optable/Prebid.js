<!DOCTYPE html>
<html lang="en">
<head>
    <title>Optable RTD submodule example - Prebid.js</title>
    <!--Optable bundle-->
    <script async src="https://prebidtest.solutions.cdn.optable.co/public-assets/prebidtest-sdk.js"></script>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <script async src="../../build/dev/prebid.js"></script>
    <!-- Analytics script will be loaded dynamically with configurable delay -->
    <meta charset="UTF-8">
    <style>
        body {
            color: #222;
            font-size: 1.5em;
            line-height: 1.6;
            font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .delim {
            margin: 27px 0 35px;
            border-width: 0;
            border-top: 1px solid #e1e1e1;
        }

        h1 {
            font-size: 30px;
            line-height: 1.35;
            font-weight: 100;
            letter-spacing: -0.5px;
        }

        a {
            color: #1eaedb;
            text-decoration: underline;
        }

        @media (min-width: 768px) {
            .container {
                padding: 0;
            }
        }

        #enriched-optable-data {
            font-size: 12px;
            max-width: 100%;
            overflow-x: scroll;
            padding: 16px;
            background-color: #efefef;
            border-radius: 6px;
        }
    </style>
    <script>
        var PREBID_TIMEOUT = 3000;
        var FAILSAFE_TIMEOUT = 5000;
        
        // Analytics configuration - switch between adapter and external script
        var ANALYTICS_CONFIG = {
            useAdapter: false, // Set to true to use generic analytics adapter, false for external script
            endpoint: 'http://localhost:3030/analytics',
            scriptLoadDelay: 2000 // Delay in milliseconds before loading analytics script (0 = immediate)
        };

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        function initAdserver() {
            if (pbjs.initAdserverSet) return;

            googletag.cmd.push(function () {
                if (pbjs.libLoaded) {
                    pbjs.que.push(function () {
                        pbjs.setTargetingForGPTAsync();
                        googletag.pubads().refresh();
                    });
                } else {
                    googletag.pubads().refresh();
                }
            });

            pbjs.initAdserverSet = true;
        }

        // Function to dynamically load analytics script with delay
        function loadAnalyticsScript() {
            return new Promise((resolve, reject) => {
                const delay = ANALYTICS_CONFIG.scriptLoadDelay || 0;
                
                console.log(`Loading analytics script with ${delay}ms delay...`);
                updateAnalyticsStatus(`Loading analytics script (${delay}ms delay)...`);
                
                setTimeout(() => {
                    const script = document.createElement('script');
                    script.src = './analytics-tracker.js';
                    script.onload = () => {
                        console.log('Analytics script loaded successfully');
                        updateAnalyticsStatus('Analytics script loaded');
                        resolve();
                    };
                    script.onerror = (error) => {
                        console.error('Failed to load analytics script:', error);
                        updateAnalyticsStatus('Analytics script failed to load');
                        reject(error);
                    };
                    document.head.appendChild(script);
                }, delay);
            });
        }

        // Function to update analytics status
        function updateAnalyticsStatus(message) {
            const statusElement = document.getElementById('analytics-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // Function to update analytics configuration display
        function updateAnalyticsConfigDisplay() {
            const modeElement = document.getElementById('analytics-mode');
            const delayElement = document.getElementById('analytics-delay');
            const endpointElement = document.getElementById('analytics-endpoint');
            
            if (modeElement) {
                modeElement.textContent = ANALYTICS_CONFIG.useAdapter ? 'Generic Adapter' : 'External Script';
            }
            if (delayElement) {
                delayElement.textContent = `${ANALYTICS_CONFIG.scriptLoadDelay || 0}ms`;
            }
            if (endpointElement) {
                endpointElement.textContent = ANALYTICS_CONFIG.endpoint;
            }
        }

        // Initialize analytics tracking based on configuration
        function initAnalytics() {
            // Load the analytics script first with configurable delay
            loadAnalyticsScript().then(() => {
                if (ANALYTICS_CONFIG.useAdapter) {
                    // Use the generic analytics adapter
                    pbjs.que.push(function () {
                        // Wait for filterData to be available from external script
                        function enableAnalytics() {
                            if (typeof window.filterData === 'undefined') {
                                setTimeout(enableAnalytics, 50);
                                return;
                            }
                            
                            updateAnalyticsStatus('Generic analytics adapter enabled');
                            
                            // Enable generic analytics adapter
                            pbjs.enableAnalytics({
                                provider: 'generic',
                                options: {
                                    url: ANALYTICS_CONFIG.endpoint,
                                    batchSize: 1, // Send events immediately
                                    events: {
                                        auctionInit: function(args) {
                                            return {
                                                eventType: 'auctionInit',
                                                timestamp: new Date().toISOString(),
                                                data: window.filterData(args)
                                            };
                                        },
                                        bidRequested: function(args) {
                                            return {
                                                eventType: 'bidRequested',
                                                timestamp: new Date().toISOString(),
                                                data: window.filterData(args)
                                            };
                                        },
                                        bidResponse: function(args) {
                                            return {
                                                eventType: 'bidResponse',
                                                timestamp: new Date().toISOString(),
                                                data: window.filterData(args)
                                            };
                                        },
                                        bidWon: function(args) {
                                            return {
                                                eventType: 'bidWon',
                                                timestamp: new Date().toISOString(),
                                                data: window.filterData(args)
                                            };
                                        }
                                    }
                                }
                            });
                        }
                        
                        enableAnalytics();
                    });
                } else {
                    updateAnalyticsStatus('External analytics tracker active');
                }
                // External script event listeners are registered automatically when useAdapter is false
            }).catch((error) => {
                console.error('Analytics initialization failed:', error);
                updateAnalyticsStatus('Analytics initialization failed');
            });
        }

        // Initialize analytics
        updateAnalyticsConfigDisplay();
        initAnalytics();

        // Auto-refresh configuration
        var AUTO_REFRESH_ENABLED = true;
        var AUTO_REFRESH_INTERVAL = 10000; // 10 seconds
        var refreshTimer;
        var refreshCount = 0;
        var adUnits; // Declare adUnits in global scope

        // Function to update status display
        function updateStatus(message) {
            const statusElement = document.getElementById('refresh-status');
            if (statusElement) {
                statusElement.textContent = `Status: ${message}`;
            }
        }

        // Function to refresh ad units
        function refreshAds() {
            if (!adUnits || !Array.isArray(adUnits) || adUnits.length === 0) {
                console.warn('adUnits not available for refresh');
                updateStatus('Error: adUnits not available');
                return;
            }

            refreshCount++;
            const timestamp = new Date().toLocaleTimeString();
            console.log(`Auto-refresh #${refreshCount} at ${timestamp}`);
            updateStatus(`Refreshing... (#${refreshCount})`);
            
            try {
                pbjs.que.push(function() {
                    try {
                        pbjs.requestBids({
                            timeout: PREBID_TIMEOUT,
                            adUnitCodes: adUnits.map(unit => unit.code),
                            bidsBackHandler: function(bidResponses) {
                                try {
                                    pbjs.setTargetingForGPTAsync();
                                    googletag.pubads().refresh();
                                    updateStatus(`Last refresh: ${timestamp} (#${refreshCount})`);
                                } catch (error) {
                                    console.warn('Error during bid response handling:', error);
                                    updateStatus(`Refresh error: ${timestamp}`);
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('Error during requestBids:', error);
                        updateStatus(`Refresh error: ${timestamp}`);
                    }
                });
            } catch (error) {
                console.warn('Error queuing refresh request:', error);
                updateStatus(`Queue error: ${timestamp}`);
            }
        }

        // Function to start auto-refresh
        function startAutoRefresh() {
            if (AUTO_REFRESH_ENABLED && !refreshTimer) {
                refreshTimer = setInterval(refreshAds, AUTO_REFRESH_INTERVAL);
                console.log(`Auto-refresh started - will refresh every ${AUTO_REFRESH_INTERVAL/1000} seconds`);
                updateStatus(`Auto-refresh active (${AUTO_REFRESH_INTERVAL/1000}s interval)`);
            }
        }

        // Function to stop auto-refresh
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
                console.log('Auto-refresh stopped');
                updateStatus('Auto-refresh stopped');
            }
        }

        // Function to change analytics delay for testing
        function setAnalyticsDelay(delayMs) {
            ANALYTICS_CONFIG.scriptLoadDelay = delayMs;
            updateAnalyticsConfigDisplay();
            console.log(`Analytics delay set to ${delayMs}ms`);
        }

        // Expose control functions globally for debugging
        window.startAutoRefresh = startAutoRefresh;
        window.stopAutoRefresh = stopAutoRefresh;
        window.refreshAds = refreshAds;
        window.setAnalyticsDelay = setAnalyticsDelay;
        window.updateAnalyticsConfigDisplay = updateAnalyticsConfigDisplay;

        pbjs.que.push(function () {

            adUnits = [ // Remove var to use the global variable
                {
                    code: '/22081946781/web-sdk-demo-gam360/header-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[728, 90]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 18349132,
                            publisherId: 1078346
                        }
                    }, {
                        bidder: 'rubicon',
                        params: {
                            accountId: 13226,
                            siteId: 307728,
                            zoneId: 1553136
                        }
                    }, {
                        bidder: 'triplelift',
                        params: {
                            inventoryCode: 'fnc_desk_hp_lb1'
                        }
                    }, {
                        bidder: 'sharethrough',
                        params: {
                             pkey: 'LuB3vxGGFrBZJa6tifXW4xgK',
                        }
                    }]
                },
                {
                    code: '/22081946781/web-sdk-demo-gam360/box-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[250, 250], [300, 250], [200, 200]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 18349136,
                            publisherId: 1078346
                        }
                    }, {
                        bidder: 'rubicon',
                        params: {
                            accountId: 13226,
                            siteId: 307728,
                            zoneId: 1553140
                        }
                    }, {
                        bidder: 'triplelift',
                        params: {
                            inventoryCode: 'fnc_desk_hp_mr1'
                        }
                    }]
                },
                {
                    code: '/22081946781/web-sdk-demo-gam360/footer-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[728, 90]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 18349133,
                            publisherId: 1078346
                        }
                    }, {
                        bidder: 'rubicon',
                        params: {
                            accountId: 13226,
                            siteId: 307728,
                            zoneId: 1553138
                        }
                    }, {
                        bidder: 'triplelift',
                        params: {
                            inventoryCode: 'fnc_desk_hp_lb2'
                        }
                    }]
                },
            ];

            pbjs.setConfig({
                optableRtdConfig: { // optional, check the doc for explanation
                    email: 'email-sha256-hash',
                    phone: 'phone-sha256-hash',
                    postal_code: 'postal_code',
                },
                debug: true, // use only for testing, remove in production
                realTimeData: {
                    auctionDelay: 1000, // should be set lower in production use
                    dataProviders: [
                        {
                            name: 'optable',
                            waitForIt: true,
                            params: {
                                bundleUrl: "https://prebidtest.solutions.cdn.optable.co/public-assets/prebidtest-sdk.js",
                                // adserverTargeting: false,
                                handleRtd: async (reqBidsConfigObj, optableExtraData, mergeFn) => {
                                    const optableBundle = /** @type {Object} */ (window.optable.prebidtest);
                                    console.warn('Entering custom RTD handler');
                                    console.warn('reqBidsConfigObj', reqBidsConfigObj);
                                    console.warn('optableExtraData', optableExtraData);
                                    console.warn('mergeFn', mergeFn);
                                
                                    // Call Optable DCN for targeting data and return the ORTB2 object
                                    const targetingData = await optableBundle.targetingFromCache();
                                    
                                    console.warn('targetingData', targetingData);

                                    if (!targetingData || !targetingData.ortb2) {
                                        return;
                                    }

                                    mergeFn(
                                        reqBidsConfigObj.ortb2Fragments.global,
                                        targetingData.ortb2,
                                    );
                                }
                            }
                        }
                    ]
                },
            });
            pbjs.mergeConfig({
                ortb2: {
                    user: {
                        ext: {
                            eids: [{
                                id: "test.com",
                                uids: ["1","2","3"]
                            }]
                        }
                    }
                }
            });

            pbjs.addAdUnits(adUnits);
            pbjs.onEvent('auctionInit', function(data) {
                console.log("auctionInit ortb2.user:", JSON.stringify(data, null, 2));
            });

            pbjs.onEvent('bidRequested', function (data) {
                console.log('bidRequested event fired:', data);
                try {
                    window.optable.cmd.push(() => {
                        document.getElementById('enriched-optable').style.display = 'block';
                        document.getElementById('enriched-optable-data').textContent = JSON.stringify(data.ortb2.user, null, 2);
                    });
                } catch (e) {
                    console.error('Exception while trying to display enriched data', e);
                }
            });

            pbjs.onEvent('bidResponse', function (bid) {
                console.log('bidResponse event fired:', bid);
                console.log('Bid CPM:', bid.cpm);
                console.log('Bid Size:', bid.size);
                console.log('Bid Ad ID:', bid.adId);
                console.log('Bid Bidder:', bid.bidder);
                console.log('Bid Ad Unit Code:', bid.adUnitCode);
            });

            pbjs.onEvent('bidWon', function (bid) {
                console.log('bidWon event fired:', bid);
                console.log('Winning Bid CPM:', bid.cpm);
                console.log('Winning Bid Ad ID:', bid.adId);
                console.log('Winning Bid Bidder:', bid.bidder);
                console.log('Winning Bid Ad Unit Code:', bid.adUnitCode);
                console.log('Winning Bid Status:', bid.status);
            });

            pbjs.requestBids({
                timeout: PREBID_TIMEOUT,
                bidsBackHandler: function (bidResponses) {
                    initAdserver();
                    // Start auto-refresh after initial load
                    setTimeout(startAutoRefresh, 2000); // Wait 2 seconds after initial load
                }
            });
        });
        setTimeout(initAdserver, FAILSAFE_TIMEOUT);
    </script>

    <script>
        googletag.cmd.push(function () {
            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/header-ad',
                    [[728, 90]],
                    'div-gpt-ad-1598295788551-0'
                )
                .addService(googletag.pubads());

            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/box-ad',
                    [[250, 250], [300, 250], [200, 200]],
                    'div-gpt-ad-1598295897480-0'
                )
                .addService(googletag.pubads());

            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/footer-ad',
                    [[728, 90]],
                    'div-gpt-ad-1598296001655-0'
                )
                .addService(googletag.pubads());

            googletag.pubads().disableInitialLoad();
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
</head>
<body>
    <main class="container">
        <div class="row">
            <img
                src="https://demo.optable.co/images/logo.png"
                width="200"
                alt="optable"
                style="margin-top: 48px"/>
            <hr class="delim" />
        </div>
        <div class="row">
            <h1>Optable RTD module example</h1>
        </div>
        
        <div class="row" style="margin-bottom: 20px;">
            <div style="background-color: #f8f8f8; padding: 15px; border-radius: 5px;">
                <strong>Auto-refresh Controls:</strong>
                <button onclick="startAutoRefresh()" style="margin-left: 10px; padding: 5px 10px;">Start Auto-refresh</button>
                <button onclick="stopAutoRefresh()" style="margin-left: 5px; padding: 5px 10px;">Stop Auto-refresh</button>
                <button onclick="refreshAds()" style="margin-left: 5px; padding: 5px 10px;">Manual Refresh</button>
                <span id="refresh-status" style="margin-left: 15px; font-weight: normal;">Status: Ready</span>
            </div>
        </div>
        
        <div class="row" style="margin-bottom: 20px;">
            <div style="background-color: #e8f4f8; padding: 15px; border-radius: 5px;">
                <strong>Analytics Status:</strong>
                <span id="analytics-status" style="margin-left: 15px; font-weight: normal;">Initializing...</span>
                <br><br>
                <strong>Configuration:</strong>
                <span style="margin-left: 15px; font-weight: normal;">
                    Mode: <code id="analytics-mode">External Script</code> | 
                    Delay: <code id="analytics-delay">2000ms</code> | 
                    Endpoint: <code id="analytics-endpoint">http://localhost:3030/analytics</code>
                </span>
            </div>
        </div>

        <h3>web-sdk-demo-gam360/header-ad</h3>
        <div id="div-gpt-ad-1598295788551-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598295788551-0');
                });
            </script>
        </div>

        <h3>web-sdk-demo-gam360/box-ad</h3>
        <div id="div-gpt-ad-1598295897480-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598295897480-0');
                });
            </script>
        </div>

        <h3>web-sdk-demo-gam360/footer-ad</h3>
        <div id="div-gpt-ad-1598296001655-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598296001655-0');
                });
            </script>
        </div>

        <div id="enriched-optable" style="display: none;">
            <h3>Enriched ortb2.user data from Optable RTD module</h3>
            <pre id="enriched-optable-data"></pre>
        </div>
    </main>
</body>
</html>
